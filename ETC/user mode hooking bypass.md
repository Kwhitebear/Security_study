# user mode hooking bypass

샌드박스(Sandbox) 기반의 보안 솔루션이나 안티바이러스(Anti-virus,백신) 제품의 행위 탐지 엔진은 악성코드의 행위를 토대로 악성 여부를 판단하고 탐지한다.<br>
유저 모드 후킹(User-Mode Hooking) 기법은 이러한 악성코드의 행위를 파악하기 위한 대표적인 기법 중 하나이다.<br>
악성코드가 실행될 때 행위에 대한 모니터링을 담당하는 DLL Injection하며, 해당 악성코드 내부에 Injection된 모니터링 DLL은 악성 행위에 필요한 주요 API 함수들을 후킹한다.<br>
이후 악성코드가 주요 API들을 호출하면 모니터링 DLL에서는 호출된 API들을 로그로 남겨 악성 행위를 판단하고 분석가가 생성한 룰을 통해 탐지까지 진행할 수 있다.<br>

특징적인 점은 유저 모드 후킹 시 주로 ntdll.dll 에서 제공하는 Native API 대상으로 한다는 점이다. 대부분의 악성코드는 악성 행위를 위해 프로세스나 메모리 혹은 파일 입출력과 관련된 자원을 사용하는데,<br>
이 자원을 사용하기 위한 API들 중 대다수는 최종적으로 ntdll.dll을 통해 시스템 콜을 호출하기 때문이다.<br>

최근 악성코드 제작자는 이러한 유저 모드 후킹 방식을 사용하는 보안 제품들을 우회하기 위해 점차 고도화된 방식의 유저 모드 후킹 우회 기법들을 개발하여 이를 악용하고 있다.<br>

# 유저 모드 후킹 우회 기법 개요

유저 모드 후킹 우회 기법은 ntdll의 후킹 여부를 검사하는 방식과 ntdll을 재로드하는 방식, 시스템 콜을 직접 호출하는 방식이 있다.<br>

먼저 ntdll의 후킹 여부를 검사하는 방식의 경우, 악성코드는 시스템 폴더의 ntdll.dll을 메모리에 읽어와 프로세스 실행 시 로드된 ntdll과 코드를 비교하며 차이가 있는지 확인한다.<br>
만약 코드에 차이가 있다면 후킹이 됐다고 판단하여 로드된 ntdll의 코드를 원본 코드로 원복시켜 후킹을 우회한다.<br>

ntdll 재로드하는 방식은 프로세스 내부에 ntdll.dll을 또 로드하여 프로세스 실행 시 로드된 기존 ntdll.dll의 API를 호출하지 않는 방법이다.<br>
기본적인 개념으로는 같은 dll을 재로드 할 수 없으나 간단한 트릭을 이용해 같은 dll을 재로드 시킬수 있다.<br>

마지막으로 직접 시스템 콜을 호출하는 방식이 있다. ntdll.dll의 Native API는 커널에 자원을 요청할 경우 해당 기능에 맞는 번호와 함께 시스템 콜을 호출하는데, 악성코드 역시 해당 기능에 맞는 번호를 구성하고<br>
시스템 콜을 호출하여 후킹 대상인 ntdll을 거치지 않고 목적을 달성할 수 있다.<br>

<h2>NTDLL 검사하는 방식</h2>

<strong>악성코드 샘플명: Parasite HTTP(MD5: 6cd0020727088daeecd462b2d844d536)</storng>
